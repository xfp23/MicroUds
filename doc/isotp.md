
# 🚀 ISO-TP 多帧规则（大于 7 字节）

假设我们要发送 **N 字节（>7）** 报文。

---

## 1️⃣ First Frame (FF) — 首帧

**作用**：告诉接收方这是多帧报文，并提供总长度。

**总长度字段**：12 位（即报文总长度 ≤ 4095 字节）

### 格式（字节级）：

| 字节序      | 位   | 含义                          |
| -------- | --- | --------------------------- |
| Byte 0   | 7~4 | **帧类型** = `0x1` → 表示 FF     |
|          | 3~0 | **总长度高 4 位** (12bit 总长度高4位) |
| Byte 1   | 7~0 | **总长度低 8 位** (12bit 总长度低8位) |
| Byte 2~7 | 7~0 | **首帧负载**，最多 6 字节数据          |

> ⚠️ 解释：
>
> * 总长度 = ((Byte0 & 0x0F) << 8) | Byte1
> * Byte2~7 是报文的前 6 字节数据
> * 发送后等待 **Flow Control** 帧

---

## 2️⃣ Flow Control (FC) — 流控帧

**作用**：接收方告诉发送方：

* 每次可以发多少 CF（Block Size）
* CF 之间的最小间隔（STmin）

### 格式（字节级）：

| 字节序      | 位   | 含义                                      |
| -------- | --- | --------------------------------------- |
| Byte 0   | 7~4 | **帧类型** = `0x3` → 表示 FC                 |
|          | 3~0 | 保留/子类型（通常 0）                            |
| Byte 1   | 7~0 | **Block Size (BS)**：一次允许发送 CF 数量（0=无限制） |
| Byte 2   | 7~0 | **STmin**：连续帧最小间隔时间（ms 或 100µs，取决于协议）   |
| Byte 3~7 | 保留  | 无效                                      |

> ⚠️ 接收方收到 FF 后必须发送 FC，否则发送方等待超时。

---

## 3️⃣ Consecutive Frame (CF) — 连续帧

**作用**：发送剩余数据，每帧 7 字节，带序号。

### 格式（字节级）：

| 字节序      | 位   | 含义                                      |
| -------- | --- | --------------------------------------- |
| Byte 0   | 7~4 | **帧类型** = `0x2` → CF                    |
|          | 3~0 | **Sequence Number (SN)**：从 1 开始，1~15 循环 |
| Byte 1~7 | 7~0 | **数据负载**，最多 7 字节                        |

> ⚠️ 发送方按 SN 顺序发送，每块 CF 之前遵守 FC 的 BS 和 STmin。

---

## 4️⃣ 举例：20 字节报文

假设报文内容 `[A1..T1]` 共 20 字节。

**FF**（总长度=20）：

```
Byte0: 0x11  ; 高4位=1(FIRST FRAME), 低4位=1 (20>>8=0x14>>8=0x1)
Byte1: 0x14  ; 低8位=0x14 (20)
Byte2~7: A1 B2 C3 D4 E5 F6  ; 前6字节数据
```

**FC**（接收方回应）：

```
Byte0: 0x30  ; 高4位=3(FC)
Byte1: 0x00  ; BS=0 (无限制)
Byte2: 0x00  ; STmin=0ms
```

**CF #1**：

```
Byte0: 0x21  ; 高4位=2(CF), 低4位=1(SN)
Byte1~7: G7 H8 I9 J10 K11 L12 M13  ; 下7字节
```

**CF #2**：

```
Byte0: 0x22  ; SN=2
Byte1~7: N14 O15 P16 Q17 R18 S19 T20  ; 剩余 7 字节
```

> 这样 6 + 7 + 7 = 20 字节完整传输。

---

💡 **关键总结**

1. **FF** → 总长度 12bit + 前 6 字节数据
2. **FC** → Block Size + STmin 控制发送节奏
3. **CF** → 每帧 7 字节 + SN
4. **SF** 仅用于 ≤7 字节，不涉及分帧

---